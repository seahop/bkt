services:
  postgres:
    image: postgres:16-alpine
    container_name: bkt-db
    entrypoint: ["/bin/bash", "/postgres-init-ssl.sh"]
    command: >
      postgres
      -c ssl=on
      -c ssl_cert_file=/var/lib/postgresql/certs/server.crt
      -c ssl_key_file=/var/lib/postgresql/certs/server.key
      -c ssl_ca_file=/var/lib/postgresql/certs/ca.crt
    environment:
      POSTGRES_USER: objectstore
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Generated by setup.py
      POSTGRES_DB: objectstore
    # Database is only accessible within Docker network (not exposed to host)
    # Use: docker exec -it bkt-db psql -U objectstore -d objectstore
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./docker/postgres-init-ssl.sh:/postgres-init-ssl.sh:ro
      - ./certs/postgres:/ssl-certs:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U objectstore"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - bkt-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    container_name: bkt-backend
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: objectstore
      DB_PASSWORD: ${DB_PASSWORD}  # Generated by setup.py
      DB_NAME: objectstore
      DB_SSL_MODE: require
      JWT_SECRET: ${JWT_SECRET:-dev_jwt_secret_change_in_production}  # Generated by setup.py
      SERVER_PORT: 9000
      # TLS Configuration
      TLS_ENABLED: "true"
      TLS_CERT_FILE: /certs/backend.crt
      TLS_KEY_FILE: /certs/backend.key
      TLS_CA_FILE: /certs/ca.crt
      # Admin Configuration (from .env file)
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@localhost}
      ALLOW_REGISTRATION: ${ALLOW_REGISTRATION:-false}
      # Google SSO Configuration
      GOOGLE_SSO_ENABLED: ${GOOGLE_SSO_ENABLED:-false}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URL: ${GOOGLE_REDIRECT_URL:-https://localhost:9443/api/auth/google/callback}
      # Vault SSO Configuration (legacy JWT)
      VAULT_SSO_ENABLED: ${VAULT_SSO_ENABLED:-false}
      VAULT_ADDR: ${VAULT_ADDR:-https://vault.example.com:8200}
      VAULT_JWT_PATH: ${VAULT_JWT_PATH:-auth/jwt}
      VAULT_JWT_ROLE: ${VAULT_JWT_ROLE:-object-storage-users}
      VAULT_JWT_AUDIENCE: ${VAULT_JWT_AUDIENCE:-object-storage}
      # Vault OIDC Configuration (browser-based SSO with PKCE)
      VAULT_OIDC_ENABLED: ${VAULT_OIDC_ENABLED:-false}
      VAULT_OIDC_CLIENT_ID: ${VAULT_OIDC_CLIENT_ID:-}
      VAULT_OIDC_PROVIDER_URL: ${VAULT_OIDC_PROVIDER_URL:-}
      VAULT_OIDC_REDIRECT_URL: ${VAULT_OIDC_REDIRECT_URL:-https://localhost:9443/api/auth/vault/callback}
      VAULT_OIDC_SCOPES: ${VAULT_OIDC_SCOPES:-openid profile}
      # Frontend URL (for SSO redirects back to frontend)
      FRONTEND_URL: ${FRONTEND_URL:-https://localhost}
      # Storage Configuration
      STORAGE_BACKEND: ${STORAGE_BACKEND:-local}  # "local" or "s3"
      STORAGE_ROOT: ${STORAGE_ROOT:-/data/buckets}
      # S3 Storage Configuration (optional, for S3 backend)
      S3_ENABLED: ${S3_ENABLED:-false}
      S3_ENDPOINT: ${S3_ENDPOINT:-s3.amazonaws.com}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_BUCKET_PREFIX: ${S3_BUCKET_PREFIX:-}
      S3_USE_SSL: ${S3_USE_SSL:-true}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-false}  # Set to true for MinIO
    ports:
      - "9443:9443"
    volumes:
      - ./data/buckets:/data/buckets
      - ./backend:/app
      - ./certs/backend:/certs:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - bkt-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: bkt-frontend
    environment:
      VITE_API_URL: https://localhost:9443
      VITE_USE_HTTPS: "true"
    ports:
      - "5173:5173"
      - "443:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - ./certs/frontend:/certs:ro
    depends_on:
      - backend
    networks:
      - bkt-network

networks:
  bkt-network:
    driver: bridge

volumes:
  postgres-data:
